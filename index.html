<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>HVAC Quote Builder (No React)</title>
<style>
:root { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial; }
body { margin: 24px; background:#0b0c10; color:#e8e8e8; }
.card { max-width: 1100px; margin: 0 auto; background:#12141a; padding:24px; border-radius:16px; box-shadow: 0 10px 30px rgba(0,0,0,.35); }
h1 { margin:0 0 8px; font-size:24px; }
h2 { font-size:16px; margin:0 0 8px; opacity:.9 }
.grid { display:grid; gap:12px; }
.cols-3 { grid-template-columns: repeat(3, minmax(0, 1fr)); }
.cols-4 { grid-template-columns: repeat(4, minmax(0, 1fr)); }
.section { border:1px solid #2a2f3a; border-radius:14px; padding:14px; background:#0f1116; }
label { font-size:12px; opacity:.8; display:block; margin-bottom:6px; }
input, select, button, textarea {
  width:100%; padding:10px 12px; border-radius:10px; border:1px solid #2a2f3a;
  background:#0b0e13; color:#e8e8e8; outline:none;
}
input[type="range"] { padding:0; }
.small { font-size:12px; opacity:.8; }
.row { display:flex; align-items:center; justify-content:space-between; font-size:14px; padding:3px 0; }
.hr { height:1px; background:#272b35; margin:8px 0; }
.btn { background:#3b82f6; border:0; cursor:pointer; font-weight:700; }
.bad { color:#fca5a5; }
.total { font-size:24px; font-weight:800; }
.kpi { display:grid; grid-template-columns: repeat(3, 1fr); gap:12px; }
.kpi > div { border:1px dashed #2a2f3a; border-radius:12px; padding:12px; text-align:center; }
</style>
</head>
<body>
  <div class="card">
    <h1>HVAC Quote Builder</h1>
    <div class="small" id="status">Loading data.json…</div>

    <div class="grid" style="margin-top:14px" id="app" hidden>
      <!-- Installers -->
      <div class="section">
        <h2>Installers</h2>
        <div class="row" style="gap:12px">
          <div style="flex:0 0 180px">
            <label>Global Hours</label>
            <input id="globalHours" type="number" min="0" step="0.5" value="8">
          </div>
          <div class="small">Each row defaults to Global Hours unless you override.</div>
        </div>
        <div class="grid cols-3" id="installerRows" style="margin-top:10px"></div>
      </div>

      <!-- Equipment -->
      <div class="grid cols-3">
        <div class="section">
          <h2>Furnace</h2>
          <select id="furnace"></select>
        </div>
        <div class="section">
          <h2>AC</h2>
          <select id="ac"></select>
        </div>
        <div class="section">
          <h2>Coil</h2>
          <select id="coil"></select>
        </div>
      </div>

      <!-- Direct adders -->
      <div class="grid cols-4">
        <div class="section">
          <label>Thermostat ($)</label>
          <input id="thermostat" type="number" min="0" value="0">
        </div>
        <div class="section">
          <label>Warranty ($)</label>
          <input id="warranty" type="number" min="0" value="0">
        </div>
        <div class="section">
          <label>Permit fee ($)</label>
          <input id="permit" type="number" min="0" value="0">
        </div>
        <div class="section">
          <label>Miscellaneous ($)</label>
          <input id="misc" type="number" min="0" value="0">
        </div>
      </div>

      <!-- Fees / targets -->
      <div class="grid cols-3">
        <div class="section">
          <h2>Commission (%)</h2>
          <input id="commission" type="range" min="2" max="10" step="0.5" value="4" oninput="document.getElementById('commissionOut').textContent=this.value + '%'">
          <div class="small" id="commissionOut">4%</div>
        </div>
        <div class="section">
          <h2>Financing plan</h2>
          <select id="financing"></select>
        </div>
        <div class="section">
          <h2>Target Margin (%)</h2>
          <input id="margin" type="range" min="40" max="60" step="1" value="50" oninput="document.getElementById('marginOut').textContent=this.value + '%'">
          <div class="small" id="marginOut">50%</div>
        </div>
      </div>

      <!-- KPIs -->
      <div class="kpi">
        <div>
          <div class="small">Labor</div>
          <div id="kLabor" class="total">$0.00</div>
        </div>
        <div>
          <div class="small">Equipment</div>
          <div id="kEquip" class="total">$0.00</div>
        </div>
        <div>
          <div class="small">Total Direct</div>
          <div id="kDirect" class="total">$0.00</div>
        </div>
      </div>

      <!-- Price -->
      <div class="grid cols-3">
        <div class="section">
          <h2>Built-in Fees</h2>
          <div class="row"><div>Commission ($)</div><div id="outComm">$0.00</div></div>
          <div class="row"><div>Financing ($)</div><div id="outFin">$0.00</div></div>
          <div class="row"><div>COGS (excl. margin)</div><div id="outCogs">$0.00</div></div>
        </div>
        <div class="section">
          <h2>Final Price</h2>
          <div id="invalid" class="small bad" style="display:none">Invalid: 1 − commission − financing − margin ≤ 0.</div>
          <div id="outPrice" class="total">$0.00</div>
          <div class="row"><div>Gross Margin ($)</div><div id="outGM">$0.00</div></div>
          <button id="export" class="btn" style="margin-top:10px">Export quote.json</button>
        </div>
        <div class="section">
          <h2>Selections</h2>
          <div class="row"><div>Furnace</div><div id="selFurn">—</div></div>
          <div class="row"><div>AC</div><div id="selAC">—</div></div>
          <div class="row"><div>Coil</div><div id="selCoil">—</div></div>
        </div>
      </div>
    </div>
  </div>

<script>
const fmt = n => (Number.isFinite(n) ? n : 0).toLocaleString(undefined,{style:'currency',currency:'USD'});
const num = v => { const n = typeof v === 'string' ? parseFloat(v) : v; return Number.isFinite(n) ? n : 0; };

const state = {
  data:null,
  installers: [ {name:'', hours:''}, {name:'', hours:''}, {name:'', hours:''}, {name:'', hours:''} ]
};

function el(tag, attrs={}, ...kids){
  const n=document.createElement(tag);
  for (const [k,v] of Object.entries(attrs)) {
    if (k==='class') n.className=v;
    else if (k.startsWith('on') && typeof v==='function') n.addEventListener(k.slice(2), v);
    else if (v!==undefined && v!==null) n.setAttribute(k,v);
  }
  kids.forEach(k => n.append(k instanceof Node ? k : document.createTextNode(String(k))));
  return n;
}

function rowInstaller(i){
  const wrap = el('div', {class:'section'});
  const sel = el('select', {id:`instName${i}`});
  sel.append(el('option', {value:''}, '— Select installer —'));
  state.data.installers.forEach(inst=>{
    sel.append(el('option', {value:inst.name}, `${inst.name} — $${inst.base_rate}/hr · Loaded $${inst.loaded_rate}/hr`));
  });
  const hrs = el('input', {id:`instHours${i}`, type:'number', min:'0', step:'0.5', value:''});
  wrap.append(
    el('label', {}, `Installer ${i+1}`), sel,
    el('label', {style:'margin-top:8px'}, 'Hours (override; blank = Global)'), hrs,
    el('div', {class:'small', style:'margin-top:6px'}, 'Row total shows in Labor KPI.')
  );
  sel.addEventListener('change', calc);
  hrs.addEventListener('input', calc);
  return wrap;
}

function populateSelectors(){
  const furnace = document.getElementById('furnace');
  const ac = document.getElementById('ac');
  const coil = document.getElementById('coil');
  furnace.append(el('option', {value:''}, '— Select furnace —'));
  ac.append(el('option', {value:''}, '— Select AC —'));
  coil.append(el('option', {value:''}, '— Select coil —'));
  state.data.furnaces.forEach(x => furnace.append(el('option', {value:x.model}, `${x.model} — $${x.total_cost}`)));
  state.data.acs.forEach(x => ac.append(el('option', {value:x.model}, `${x.model} — $${x.total_cost}`)));
  state.data.coils.forEach(x => coil.append(el('option', {value:x.model}, `${x.model} — ${x.total_cost!=null?('$'+x.total_cost):'— (0)'}`)));

  const financing = document.getElementById('financing');
  state.data.financingPlans.forEach(p => financing.append(el('option', {value:p.name}, `${p.name} — ${(p.percent*100).toFixed(2)}% dealer fee`)));
}

function currentSelections(){
  const f = document.getElementById('furnace').value;
  const a = document.getElementById('ac').value;
  const c = document.getElementById('coil').value;
  const fMap = Object.fromEntries(state.data.furnaces.map(i=>[i.model, i.total_cost||0]));
  const aMap = Object.fromEntries(state.data.acs.map(i=>[i.model, i.total_cost||0]));
  const cMap = Object.fromEntries(state.data.coils.map(i=>[i.model, i.total_cost||0]));
  return {
    f, a, c,
    equip: (fMap[f]||0) + (aMap[a]||0) + (cMap[c]||0)
  };
}

function calc(){
  const globalHours = num(document.getElementById('globalHours').value);
  const thermostat = num(document.getElementById('thermostat').value);
  const warranty   = num(document.getElementById('warranty').value);
  const permit     = num(document.getElementById('permit').value);
  const misc       = num(document.getElementById('misc').value);
  const commissionPct = num(document.getElementById('commission').value)/100;
  const marginPct     = num(document.getElementById('margin').value)/100;

  const financingName = document.getElementById('financing').value;
  const finPct = (state.data.financingPlans.find(p=>p.name===financingName)?.percent) || 0;

  // installers
  let labor = 0;
  for (let i=0;i<4;i++){
    const name = document.getElementById(`instName${i}`).value;
    const hoursRaw = document.getElementById(`instHours${i}`).value;
    const hours = hoursRaw === '' ? globalHours : num(hoursRaw);
    const rate = (state.data.installers.find(x=>x.name===name)?.loaded_rate) || 0;
    labor += rate * hours;
  }

  const { f, a, c, equip } = currentSelections();
  const D = labor + equip + thermostat + warranty + permit + misc;

  const denom = 1 - commissionPct - finPct - marginPct;
  const invalid = denom <= 0;

  const price = invalid ? NaN : D / denom;
  const commission$ = invalid ? NaN : price * commissionPct;
  const financing$  = invalid ? NaN : price * finPct;
  const gm$         = invalid ? NaN : price * marginPct;
  const cogs$       = invalid ? NaN : price - gm$;

  // UI
  document.getElementById('kLabor').textContent = fmt(labor);
  document.getElementById('kEquip').textContent = fmt(equip);
  document.getElementById('kDirect').textContent = fmt(D);

  document.getElementById('outComm').textContent = Number.isFinite(commission$)?fmt(commission$):'—';
  document.getElementById('outFin').textContent  = Number.isFinite(financing$)?fmt(financing$):'—';
  document.getElementById('outCogs').textContent = Number.isFinite(cogs$)?fmt(cogs$):'—';

  document.getElementById('invalid').style.display = invalid ? 'block' : 'none';
  document.getElementById('outPrice').textContent = Number.isFinite(price)?fmt(price):'—';
  document.getElementById('outGM').textContent = Number.isFinite(gm$)?fmt(gm$):'—';

  document.getElementById('selFurn').textContent = f || '—';
  document.getElementById('selAC').textContent = a || '—';
  document.getElementById('selCoil').textContent = c || '—';
}

function wire(){
  // build 4 installer rows
  const holder = document.getElementById('installerRows');
  holder.innerHTML = '';
  for (let i=0;i<4;i++) holder.append(rowInstaller(i));

  // events
  ['globalHours','furnace','ac','coil','thermostat','warranty','permit','misc','commission','financing','margin']
    .forEach(id => document.getElementById(id).addEventListener('input', calc));

  document.getElementById('export').addEventListener('click', () => {
    const payload = {
      selections: {
        installers: Array.from({length:4}, (_,i)=>({
          name: document.getElementById(`instName${i}`).value,
          hours: document.getElementById(`instHours${i}`).value || document.getElementById('globalHours').value
        })),
        furnace: document.getElementById('furnace').value,
        ac: document.getElementById('ac').value,
        coil: document.getElementById('coil').value,
        thermostat: num(document.getElementById('thermostat').value),
        warranty: num(document.getElementById('warranty').value),
        permit: num(document.getElementById('permit').value),
        misc: num(document.getElementById('misc').value),
        commissionPct: num(document.getElementById('commission').value),
        financingName: document.getElementById('financing').value,
        marginPct: num(document.getElementById('margin').value)
      }
    };
    const blob = new Blob([JSON.stringify(payload, null, 2)], { type:'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'quote.json'; a.click();
    URL.revokeObjectURL(url);
  });

  calc();
}

async function boot(){
  try {
    const res = await fetch('./data.json', { cache:'no-store' });
    if (!res.ok) throw new Error(`HTTP ${res.status} loading data.json`);
    state.data = await res.json();
    document.getElementById('status').textContent = 'Ready';
    document.getElementById('app').hidden = false;
    populateSelectors();
    wire();
  } catch (e) {
    document.getElementById('status').textContent = 'Error: ' + e.message;
  }
}
boot();
</script>
</body>
</html>
